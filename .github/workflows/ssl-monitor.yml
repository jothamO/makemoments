name: SSL Certificate Monitor

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday
  workflow_dispatch: # Allow manual trigger

jobs:
  check-ssl:
    runs-on: ubuntu-latest
    steps:
      - name: Check SSL Expiry
        id: ssl_check
        run: |
          DOMAIN="makemoments.xyz"
          EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))
          
          echo "Certificate for $DOMAIN expires on $EXPIRY_DATE ($DAYS_LEFT days left)"
          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
          
          if [ $DAYS_LEFT -lt 30 ]; then
            echo "ALERT: SSL Certificate expiring soon!"
            exit 1
          fi

      - name: Create Alert Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸš¨ URGENT: SSL Certificate Expiring Soon (makemoments.xyz)",
              body: "The SSL certificate for **makemoments.xyz** is scheduled to expire in less than 30 days. Please renew it immediately to avoid service interruption."
            })
